<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f0f4f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Doolen Family Facetime</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Quicksand for a friendly, rounded feel -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f4f8; /* Soft blue-gray background */
            color: #334155; /* Slate-700 for text */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85); /* Light glass */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }

        video {
            /* transform: scaleX(-1); Mirror effect handled in JS for front camera only */
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* Animation for notifications */
        @keyframes slideIn {
            from { transform: translateY(-100%) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast {
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .toast.hiding {
            animation: fadeOut 0.3s ease-in forwards;
        }

        /* Blob Animation */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }

        /* Mobile specific styles for inputs to prevent zoom */
        input[type="text"] {
            font-size: 16px; /* Prevents iOS zoom */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden bg-slate-50">

    <!-- Ambient Background Elements (Pastel Colors) -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Notifications Container -->
    <div id="notification-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm space-y-2 pointer-events-none"></div>

    <!-- Main App Container -->
    <div class="glass-panel w-full max-w-4xl rounded-3xl p-6 md:p-10 relative transition-all duration-500 ease-in-out flex flex-col" id="app-container" style="min-height: 80vh; justify-content: center;">
        
        <!-- Header -->
        <header class="text-center mb-6 md:mb-10 transition-all duration-300" id="main-header">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700 mb-2 flex items-center justify-center gap-3">
                <i class="fa-solid fa-house-chimney-user text-indigo-500"></i>
                <span class="hidden md:inline">Doolen Family Facetime</span>
                <span class="md:hidden">Doolen Family</span>
            </h1>
            <p class="text-slate-500 text-sm md:text-base font-medium">Connect with the family, wherever you are.</p>
        </header>

        <!-- SETUP SCREEN -->
        <div id="setup-screen" class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 divide-y md:divide-y-0 md:divide-x divide-slate-200">
            
            <!-- Host Section -->
            <div class="flex flex-col items-center justify-center p-4 space-y-4">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-2 shadow-inner">
                    <i class="fa-solid fa-couch text-2xl md:text-3xl text-indigo-500"></i>
                </div>
                <h3 class="text-xl md:text-2xl font-bold text-slate-700">Host a Room</h3>
                <p class="text-slate-500 text-sm text-center px-4">Name your room and wait for family.</p>
                
                <div class="w-full max-w-xs mt-2">
                    <div class="text-xs font-bold text-slate-400 mb-1 ml-1 uppercase tracking-wide">Create Room Name</div>
                    <div class="flex gap-2">
                        <input type="text" id="host-room-input" placeholder="e.g. SundayDinner" autocapitalize="off" autocorrect="off" class="flex-1 bg-white border-2 border-slate-200 rounded-xl py-3 px-4 text-slate-700 font-medium focus:outline-none focus:border-indigo-400 focus:ring-4 focus:ring-indigo-100 transition-all placeholder-slate-400">
                        <button id="host-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl px-5 py-2 shadow-lg shadow-indigo-200 transition-all transform hover:scale-105 active:scale-95 whitespace-nowrap">
                            Start
                        </button>
                    </div>
                </div>
                <div id="host-status-msg" class="text-xs text-indigo-500 font-medium h-4"></div>
            </div>

            <!-- Join Section -->
            <div class="flex flex-col items-center justify-center p-4 space-y-4">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-sky-50 rounded-full flex items-center justify-center mb-2 shadow-inner">
                    <i class="fa-solid fa-mug-hot text-2xl md:text-3xl text-sky-500"></i>
                </div>
                <h3 class="text-xl md:text-2xl font-bold text-slate-700">Join a Room</h3>
                <p class="text-slate-500 text-sm text-center px-4">Enter the room name to join.</p>
                
                <div class="w-full max-w-xs mt-2">
                    <div class="text-xs font-bold text-slate-400 mb-1 ml-1 uppercase tracking-wide">Enter Room Name</div>
                    <div class="flex gap-2">
                        <input type="text" id="join-room-input" placeholder="e.g. SundayDinner" autocapitalize="off" autocorrect="off" class="flex-1 bg-white border-2 border-slate-200 rounded-xl py-3 px-4 text-slate-700 font-medium focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all placeholder-slate-400">
                        <button id="join-btn" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl px-5 py-2 shadow-lg shadow-sky-200 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none whitespace-nowrap">
                            Join
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALL SCREEN (Hidden by default) -->
        <div id="call-screen" class="hidden flex flex-col flex-grow h-full relative">
            
            <!-- Video Area -->
            <div class="relative flex-grow w-full rounded-2xl overflow-hidden bg-slate-900 shadow-xl mb-4">
                
                <!-- Remote Video -->
                <div class="absolute inset-0 w-full h-full">
                    <video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video>
                    
                    <!-- Remote Loading State -->
                    <div id="remote-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 z-10">
                        <div class="relative">
                            <div class="w-16 h-16 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin mb-4"></div>
                        </div>
                        <span class="text-slate-500 font-medium text-lg">Connecting...</span>
                        <div id="connection-status" class="text-sky-500 text-sm font-bold mt-2 animate-pulse">Initializing...</div>
                        
                        <div id="waiting-msg" class="text-indigo-400 text-sm mt-4 hidden">
                            Room: <span id="room-name-display" class="font-bold text-indigo-600"></span><br>
                            Waiting for family to join...
                        </div>
                    </div>

                    <div class="absolute top-4 left-4 bg-black/40 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-white flex items-center gap-2 shadow-sm z-0">
                        Family
                    </div>
                </div>

                <!-- Local Video (PiP) -->
                <div class="absolute bottom-4 right-4 w-32 md:w-48 aspect-[3/4] md:aspect-video bg-slate-800 rounded-xl overflow-hidden shadow-2xl border-2 border-white ring-1 ring-black/10 z-20 transition-all duration-300">
                    <video id="local-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <div class="absolute bottom-2 left-2 bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded-full text-[10px] font-bold text-indigo-600 flex items-center gap-1 shadow-sm md:flex hidden">
                        Me
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center bg-slate-800/90 z-30 hidden" id="local-video-off-overlay">
                        <i class="fa-solid fa-video-slash text-xl text-slate-400"></i>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white/90 backdrop-blur-lg rounded-2xl p-3 md:p-4 shadow-lg border border-slate-100 flex justify-evenly items-center gap-4 mx-auto w-full max-w-md">
                
                <button id="toggle-audio-btn" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-all focus:outline-none focus:ring-4 focus:ring-slate-100 active:scale-95" title="Toggle Mute">
                    <i class="fa-solid fa-microphone text-lg md:text-xl"></i>
                </button>
                
                <button id="end-call-btn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-rose-500 hover:bg-rose-600 text-white flex items-center justify-center shadow-lg shadow-rose-200 hover:shadow-rose-300 transition-all transform hover:scale-105 active:scale-95 focus:outline-none" title="End Call">
                    <i class="fa-solid fa-phone-slash text-xl md:text-2xl"></i>
                </button>
                
                <button id="toggle-video-btn" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-all focus:outline-none focus:ring-4 focus:ring-slate-100 active:scale-95" title="Toggle Camera">
                    <i class="fa-solid fa-video text-lg md:text-xl"></i>
                </button>

                <button id="flip-camera-btn" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 flex items-center justify-center transition-all focus:outline-none focus:ring-4 focus:ring-indigo-50 active:scale-95 md:hidden" title="Flip Camera">
                    <i class="fa-solid fa-camera-rotate text-lg md:text-xl"></i>
                </button>
            </div>
        </div>

    </div>

    <div class="absolute bottom-4 text-slate-400 text-xs font-medium opacity-60">
        Made with <i class="fa-solid fa-heart text-rose-300 mx-1"></i> for the Doolen Family
    </div>

    <!-- PeerJS Library -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        // --- State Management ---
        const state = {
            peer: null,
            currentCall: null,
            localStream: null,
            myId: null,
            isAudioMuted: false,
            isVideoOff: false,
            currentFacingMode: 'user',
            wakeLock: null,
            isHost: false,
            connectionTimeout: null
        };

        // --- DOM Elements ---
        const els = {
            hostRoomInput: document.getElementById('host-room-input'),
            joinRoomInput: document.getElementById('join-room-input'),
            hostBtn: document.getElementById('host-btn'),
            joinBtn: document.getElementById('join-btn'),
            hostStatusMsg: document.getElementById('host-status-msg'),
            
            setupScreen: document.getElementById('setup-screen'),
            callScreen: document.getElementById('call-screen'),
            header: document.getElementById('main-header'),
            
            localVideo: document.getElementById('local-video'),
            remoteVideo: document.getElementById('remote-video'),
            remoteLoading: document.getElementById('remote-loading'),
            waitingMsg: document.getElementById('waiting-msg'),
            connectionStatus: document.getElementById('connection-status'),
            roomNameDisplay: document.getElementById('room-name-display'),
            localVideoOverlay: document.getElementById('local-video-off-overlay'),
            
            endCallBtn: document.getElementById('end-call-btn'),
            toggleAudioBtn: document.getElementById('toggle-audio-btn'),
            toggleVideoBtn: document.getElementById('toggle-video-btn'),
            flipCameraBtn: document.getElementById('flip-camera-btn'),
            notificationContainer: document.getElementById('notification-container')
        };

        const ID_PREFIX = 'doolen-family-app-v2-';
        const JOIN_TIMEOUT_MS = 20000; // 20 Seconds timeout for joining

        // --- PeerJS Configuration (Standard P2P) ---
        const PEER_CONFIG = {
            debug: 1
        };

        // --- Wake Lock API ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        }

        function releaseWakeLock() {
            if (state.wakeLock) {
                state.wakeLock.release();
                state.wakeLock = null;
            }
        }

        // --- Notification System ---
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            let bgClass = 'bg-white border-slate-200';
            let iconClass = 'fa-info-circle';
            let textClass = 'text-slate-700';

            if (type === 'success') { bgClass = 'bg-green-50 border-green-200'; iconClass = 'fa-check-circle text-green-500'; textClass = 'text-green-800'; }
            if (type === 'error') { bgClass = 'bg-rose-50 border-rose-200'; iconClass = 'fa-circle-exclamation text-rose-500'; textClass = 'text-rose-800'; }
            if (type === 'info') { bgClass = 'bg-sky-50 border-sky-200'; iconClass = 'fa-info-circle text-sky-500'; textClass = 'text-sky-800'; }

            toast.className = `toast pointer-events-auto flex items-center p-4 mb-3 rounded-xl border ${bgClass} shadow-lg shadow-slate-200/50 backdrop-blur-sm max-w-[90vw] mx-auto transform -translate-x-1/2 left-1/2 fixed top-5 z-[100]`;
            toast.innerHTML = `
                <div class="flex-shrink-0 mr-3">
                    <i class="fa-solid ${iconClass} text-lg"></i>
                </div>
                <div class="text-sm font-bold ${textClass}">${message}</div>
            `;

            els.notificationContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000); 
        }

        // --- Network Status Monitoring ---
        window.addEventListener('offline', () => {
            showNotification('No internet connection.', 'error');
            updateStatus('Offline');
        });
        window.addEventListener('online', () => {
            showNotification('Back online. Reconnecting...', 'info');
            if (state.peer && state.peer.disconnected) {
                state.peer.reconnect();
            }
        });

        // --- Helper: Sanitize Room Name ---
        function sanitizeRoomId(input) {
            // Strong sanitization: Lowercase + remove spaces + remove special chars
            return ID_PREFIX + input.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
        }

        function updateStatus(msg) {
            els.connectionStatus.innerText = msg;
        }

        // --- Core WebRTC Logic ---

        function init() {
            // Create peer with Standard config
            state.peer = new Peer(PEER_CONFIG);

            state.peer.on('open', (id) => {
                state.myId = id;
                console.log("My Peer ID:", id);
            });

            setupPeerListeners();
        }

        function setupPeerListeners() {
            // General Peer Errors
            state.peer.on('error', (err) => {
                console.error("Peer Error:", err);
                
                if (state.connectionTimeout) clearTimeout(state.connectionTimeout);

                if (err.type === 'unavailable-id') {
                    showNotification('That room name is taken. Try another.', 'error');
                    els.hostBtn.disabled = false;
                    els.hostBtn.innerHTML = 'Start';
                    
                    if (state.isHost) {
                         state.peer.destroy();
                         init(); // Reset to client mode
                         state.isHost = false;
                    }

                } else if (err.type === 'peer-unavailable') {
                    showNotification('Room not found. Did the host start it?', 'error');
                    resetUI();
                } else if (err.type === 'network') {
                     showNotification('Network connection unstable.', 'error');
                } else if (err.type === 'disconnected') {
                     showNotification('Disconnected from server.', 'error');
                } else {
                    showNotification('Connection error: ' + err.type, 'error');
                }
            });

            // Handle Server Disconnects
            state.peer.on('disconnected', () => {
                console.log("Peer disconnected from server.");
                // Only show if we aren't intentionally closing
                if (state.peer && !state.peer.destroyed) {
                    try {
                        state.peer.reconnect();
                    } catch (e) { console.error("Reconnect failed", e); }
                }
            });

            // Incoming Calls (HOST Logic)
            state.peer.on('call', (call) => {
                console.log("Incoming call from:", call.peer);
                showNotification('Family connecting...', 'success');
                els.waitingMsg.classList.add('hidden');
                updateStatus("Answering...");
                
                startLocalStream().then(() => {
                    call.answer(state.localStream);
                    handleCall(call);
                }).catch(err => {
                    console.error("Could not answer call", err);
                    call.close();
                });
            });
        }

        // --- HOST Logic ---
        function startHosting() {
            const roomName = els.hostRoomInput.value.trim();
            if (!roomName) {
                showNotification('Please enter a room name.', 'error');
                return;
            }

            const roomId = sanitizeRoomId(roomName);

            els.hostBtn.disabled = true;
            els.hostBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

            // We must destroy the old "random" peer to take the specific named one
            if (state.peer) state.peer.destroy();

            state.peer = new Peer(roomId, PEER_CONFIG);
            state.isHost = true;

            state.peer.on('open', (id) => {
                showNotification(`Room created: ${roomName}`, 'success');
                state.myId = id;
                
                startLocalStream().then(() => {
                    transitionToCallScreen();
                    els.remoteLoading.classList.remove('hidden');
                    els.connectionStatus.classList.add('hidden'); // Hide generic status
                    els.waitingMsg.classList.remove('hidden');
                    els.roomNameDisplay.textContent = roomName;
                }).catch(() => {
                    resetUI();
                });
            });

            setupPeerListeners();
        }

        // --- JOIN Logic ---
        function joinRoom() {
            const roomName = els.joinRoomInput.value.trim();
            if (!roomName) {
                showNotification('Please enter a room name.', 'error');
                return;
            }

            const targetId = sanitizeRoomId(roomName);

            // Safety check
            if (state.peer && state.peer.id === targetId) {
                showNotification('You are already hosting this room!', 'error');
                return;
            }

            els.joinBtn.disabled = true;
            els.joinBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

            startLocalStream().then(() => {
                updateStatus("Finding Room...");
                transitionToCallScreen(); // Move to screen immediately to show status
                
                const call = state.peer.call(targetId, state.localStream);
                
                // Set Timeout specifically for the connection process
                state.connectionTimeout = setTimeout(() => {
                    if (state.currentCall && state.currentCall.open) return; 
                    
                    showNotification('Connection timed out. Is host ready?', 'error');
                    if (call) call.close();
                    resetUI();
                }, JOIN_TIMEOUT_MS);

                if (call) {
                    handleCall(call);
                } else {
                    // Immediate failure (rare)
                    throw new Error("Call init failed");
                }
            }).catch((err) => {
                console.error("Join failed", err);
                resetUI();
            });
        }

        async function startLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: state.currentFacingMode }, 
                    audio: true 
                });
                state.localStream = stream;
                els.localVideo.srcObject = stream;
                els.localVideo.style.transform = state.currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';
                updateMediaControlsUI();
                return stream;
            } catch (err) {
                console.error('Failed to get local stream', err);
                
                let msg = 'Could not access camera/microphone.';
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    msg = 'Camera permission denied. Please allow access in settings.';
                } else if (err.name === 'NotFoundError') {
                    msg = 'No camera or microphone found.';
                } else if (err.name === 'NotReadableError') {
                    msg = 'Camera/Microphone is already in use.';
                }
                
                showNotification(msg, 'error');
                throw err;
            }
        }

        function handleCall(call) {
            state.currentCall = call;
            requestWakeLock();
            
            updateStatus("Negotiating...");

            call.on('stream', (remoteStream) => {
                console.log("Received Remote Stream");
                if (state.connectionTimeout) clearTimeout(state.connectionTimeout);
                
                els.remoteVideo.srcObject = remoteStream;
                els.remoteLoading.classList.add('hidden'); // Success!
                els.waitingMsg.classList.add('hidden');
            });

            call.on('close', () => {
                showNotification('Call ended.', 'info');
                resetUI();
            });

            call.on('error', (err) => {
                console.error("Call error", err);
                showNotification('Connection dropped.', 'error');
                resetUI();
            });
            
            // Monitor ICE State (Connection health)
            const pc = call.peerConnection;
            if (pc) {
                pc.onconnectionstatechange = () => {
                    console.log("Connection State:", pc.connectionState);
                };
                
                pc.oniceconnectionstatechange = () => {
                    console.log("ICE State:", pc.iceConnectionState);
                    if (pc.iceConnectionState === 'checking') {
                         updateStatus("Checking network...");
                    } else if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                         updateStatus("Connected!");
                         // Safety clear
                         if (state.connectionTimeout) clearTimeout(state.connectionTimeout);
                    } else if (pc.iceConnectionState === 'disconnected') {
                        showNotification('Weak signal...', 'error');
                    } else if (pc.iceConnectionState === 'failed') {
                        showNotification('Firewall blocked connection.', 'error');
                        call.close();
                    }
                };
            }
        }

        function endCall() {
            if (state.connectionTimeout) clearTimeout(state.connectionTimeout);
            
            if (state.currentCall) {
                state.currentCall.close();
            }
            if (state.peer) {
                state.peer.destroy();
            }
            resetUI();
            showNotification('You left the room.', 'info');
            
            setTimeout(init, 500);
        }

        function transitionToCallScreen() {
            els.setupScreen.classList.add('hidden');
            els.header.classList.add('hidden');
            els.callScreen.classList.remove('hidden');
        }

        function resetUI() {
            if (state.connectionTimeout) clearTimeout(state.connectionTimeout);
            releaseWakeLock();
            state.isHost = false;

            if (state.localStream) {
                state.localStream.getTracks().forEach(track => track.stop());
            }
            state.localStream = null;
            state.currentCall = null;

            els.localVideo.srcObject = null;
            els.remoteVideo.srcObject = null;
            
            els.remoteLoading.classList.remove('hidden');
            els.connectionStatus.classList.remove('hidden');
            els.connectionStatus.innerText = "Ready";
            els.waitingMsg.classList.add('hidden');
            els.localVideoOverlay.classList.add('hidden');
            
            state.isAudioMuted = false;
            state.isVideoOff = false;
            state.currentFacingMode = 'user'; 
            
            updateMediaControlsUI();
            
            els.hostBtn.disabled = false;
            els.hostBtn.innerHTML = 'Start';
            els.joinBtn.disabled = false;
            els.joinBtn.innerHTML = 'Join';

            els.callScreen.classList.add('hidden');
            els.header.classList.remove('hidden');
            els.setupScreen.classList.remove('hidden');
        }

        // --- Camera Flip & Media Controls ---
        async function flipCamera() {
            if (!state.localStream) return;
            state.currentFacingMode = state.currentFacingMode === 'user' ? 'environment' : 'user';
            state.localStream.getVideoTracks().forEach(track => track.stop());
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: state.currentFacingMode },
                    audio: true
                });
                
                const newVideoTrack = newStream.getVideoTracks()[0];
                if (state.currentCall && state.currentCall.peerConnection) {
                    const sender = state.currentCall.peerConnection.getSenders().find((s) => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(newVideoTrack);
                }

                const newLocalStream = new MediaStream([newVideoTrack, state.localStream.getAudioTracks()[0]]);
                state.localStream = newLocalStream;
                els.localVideo.srcObject = newLocalStream;
                els.localVideo.style.transform = state.currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';

                if (state.isAudioMuted) newLocalStream.getAudioTracks()[0].enabled = false;

            } catch (err) {
                console.error("Error flipping camera", err);
                showNotification('Could not flip camera.', 'error');
                state.currentFacingMode = state.currentFacingMode === 'user' ? 'environment' : 'user';
            }
        }

        function toggleAudio() {
            if (!state.localStream) return;
            const audioTrack = state.localStream.getAudioTracks()[0];
            if (audioTrack) {
                state.isAudioMuted = !state.isAudioMuted;
                audioTrack.enabled = !state.isAudioMuted;
                updateMediaControlsUI();
                showNotification(state.isAudioMuted ? 'Microphone muted' : 'Microphone active', 'info');
            }
        }

        function toggleVideo() {
            if (!state.localStream) return;
            const videoTrack = state.localStream.getVideoTracks()[0];
            if (videoTrack) {
                state.isVideoOff = !state.isVideoOff;
                videoTrack.enabled = !state.isVideoOff;
                els.localVideoOverlay.classList.toggle('hidden', !state.isVideoOff);
                updateMediaControlsUI();
                showNotification(state.isVideoOff ? 'Camera paused' : 'Camera active', 'info');
            }
        }

        function updateMediaControlsUI() {
            if (state.isAudioMuted) {
                els.toggleAudioBtn.classList.replace('bg-slate-100', 'bg-rose-100');
                els.toggleAudioBtn.classList.replace('hover:bg-slate-200', 'hover:bg-rose-200');
                els.toggleAudioBtn.innerHTML = '<i class="fa-solid fa-microphone-slash text-rose-500"></i>';
            } else {
                els.toggleAudioBtn.classList.replace('bg-rose-100', 'bg-slate-100');
                els.toggleAudioBtn.classList.replace('hover:bg-rose-200', 'hover:bg-slate-200');
                els.toggleAudioBtn.innerHTML = '<i class="fa-solid fa-microphone text-slate-600"></i>';
            }
            if (state.isVideoOff) {
                els.toggleVideoBtn.classList.replace('bg-slate-100', 'bg-rose-100');
                els.toggleVideoBtn.classList.replace('hover:bg-slate-200', 'hover:bg-rose-200');
                els.toggleVideoBtn.innerHTML = '<i class="fa-solid fa-video-slash text-rose-500"></i>';
            } else {
                els.toggleVideoBtn.classList.replace('bg-rose-100', 'bg-slate-100');
                els.toggleVideoBtn.classList.replace('hover:bg-rose-200', 'hover:bg-slate-200');
                els.toggleVideoBtn.innerHTML = '<i class="fa-solid fa-video text-slate-600"></i>';
            }
        }

        // --- Event Listeners ---
        els.hostBtn.addEventListener('click', startHosting);
        els.joinBtn.addEventListener('click', joinRoom);
        els.endCallBtn.addEventListener('click', endCall);
        els.toggleAudioBtn.addEventListener('click', toggleAudio);
        els.toggleVideoBtn.addEventListener('click', toggleVideo);
        els.flipCameraBtn.addEventListener('click', flipCamera);

        // Initialization
        init();

    </script>
</body>
</html>
